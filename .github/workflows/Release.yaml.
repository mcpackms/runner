name: Run APK Downloader

on:
  push:
    branches: [ main ]

jobs:
  # 第一个 Job：负责下载 APK 并创建 Release
  run-downloader:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    # 定义该 Job 的输出变量，供后续 Job 使用
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      apk_files: ${{ steps.find_apks.outputs.files }}

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install --no-cache-dir requests

      - name: Run APK Downloader
        run: python run.py

      - name: Upload downloaded APKs
        uses: actions/upload-artifact@v4
        with:
          name: downloaded-apks
          path: |
            app-*.apk
          if-no-files-found: ignore
          retention-days: 1

      - name: Create Release
        id: create_release
        if: always()
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: apk-download-${{ github.run_id }}
          release_name: APK Download Run ${{ github.run_id }}
          body: |
            自动生成的APK下载结果
            运行ID: ${{ github.run_id }}
          draft: false
          prerelease: false

      - name: Find APK Files
        id: find_apks
        run: |
          if ls app-*.apk 1>/dev/null 2>&1; then
            files=$(python3 -c "import os, json; apk_files = [f for f in os.listdir('.') if f.startswith('app-') and f.endswith('.apk')]; print(json.dumps(apk_files))")
            echo "files=$files" >> $GITHUB_OUTPUT
          else
            echo "files=[]" >> $GITHUB_OUTPUT
          fi
          echo "Found APK files: ${{ steps.find_apks.outputs.files }}"

  # 第二个 Job：负责并行上传 Release Assets
  upload_assets:
    runs-on: ubuntu-latest
    needs: run-downloader
    if: fromJSON(needs.run-downloader.outputs.apk_files) != []
    permissions:
      contents: write

    # 使用 matrix 策略并行上传
    strategy:
      matrix:
        file: ${{ fromJSON(needs.run-downloader.outputs.apk_files) }}

    steps:
      - name: Download APKs from Artifact
        uses: actions/download-artifact@v4
        with:
          name: downloaded-apks
          path: .

      - name: Upload Release Assets
        if: always()
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # 引用上游 Job 创建的 Release 的上传 URL
          upload_url: ${{ needs.run-downloader.outputs.upload_url }}
          # 矩阵变量 file 代表当前并行实例处理的单个文件名
          asset_path: ${{ matrix.file }}
          asset_name: ${{ matrix.file }}
          asset_content_type: application/octet-stream
